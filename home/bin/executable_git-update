#!/usr/bin/env bash
# SUMMARY: git-update will get the latest for your branch along with autostashing
# replaces git-smart-pull
set -eou pipefail

source $HOME/bin/lib/common.sh

readonly upstream_branch=$(git rev-parse --abbrev-ref --symbolic-full-name "@{u}")

readonly head_sha=$(git rev-parse HEAD)

git_update_prettyprint_log () {
  local format=$(
    git config --get pretty.update ||
    echo "%C(yellow)%h%Cblue%d%Creset %s - %C(white)%an %Cgreen(%cr)%Creset")

  local merge_base_sha=$(git merge-base "$head_sha" "$remote_sha")
  git log --format="$format" --graph "$merge_base_sha".."$remote_sha"
}

header "Fetching remotes"
git fetch --all --prune | indent

header "Getting latest from remote on current branch"
git pull --rebase=merges --autostash | indent

remote_sha=$(git rev-parse "$upstream_branch")

header "Changes applied"
git_update_prettyprint_log
success "âœ… Complete"
